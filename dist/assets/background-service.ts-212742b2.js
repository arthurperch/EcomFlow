console.log("ðŸš€ EcomFlow Background Service Worker Loaded");const s={running:!1,currentTask:null,queue:[],tabStates:new Map,settings:{delays:{betweenActions:500,pageLoad:2e3,typing:50},retryAttempts:3,debugMode:!0}};chrome.runtime.onMessage.addListener((e,o,t)=>{var r;switch(console.log("ðŸ“¨ Message received:",e.type,"from tab:",(r=o.tab)==null?void 0:r.id),e.type){case"amazonDataScraped":y(e,o,t);break;case"findOnEbayByImage":S(e,o,t);break;case"research_competitor":return w(e,o,t),!0;case"soldItemsScanned":T(e);break;case"competitorScanProgress":case"competitorScanResults":case"competitorScanError":b(e);break;case"executeAutomationCommand":return g(e.command,t),!0;case"queueCommands":return L(e.commands,t),!0;case"getTabState":t({state:s.tabStates.get(e.tabId)});break;case"updateTabState":m(e.tabId,e.data),t({success:!0});break;case"showNotification":C(e.title,e.message,e.iconUrl);break;case"calculateProfit":t(E(e.data));break;case"checkVERO":t({isVERO:U(e.title||e.brand)});break;default:console.log("âš ï¸ Unknown message type:",e.type)}return!1});async function y(e,o,t){var n;const{asin:r,data:a}=e,i=(n=o.tab)==null?void 0:n.id;console.log("ðŸ“¦ Amazon scraping complete for ASIN:",r),console.log("ðŸ”„ Opening eBay and closing Amazon tab:",i);try{const c=await chrome.tabs.create({url:"https://www.ebay.com/sl/sell?sr=shListingsCTA",active:!0});console.log("âœ… eBay tab opened:",c.id),m(c.id,{source:"amazon",asin:r,productData:a,timestamp:Date.now()}),chrome.tabs.onUpdated.addListener(function l(u,d){u===c.id&&d.status==="complete"&&(chrome.tabs.onUpdated.removeListener(l),console.log("ðŸŽ¯ eBay tab loaded, sending trigger message..."),setTimeout(()=>{chrome.tabs.sendMessage(c.id,{type:"startEbayListing",asin:r,productData:a},f=>{console.log("ðŸ“¨ eBay automation response:",f)})},s.settings.delays.pageLoad))}),i&&setTimeout(()=>{chrome.tabs.remove(i,()=>{console.log("âœ… Amazon tab closed:",i)})},1e3),t({success:!0,ebayTabId:c.id})}catch(c){console.error("âŒ Error in Amazon to eBay flow:",c),t({success:!1,error:String(c)})}}async function w(e,o,t){const{username:r}=e;console.log("ðŸŽ¯ðŸŽ¯ðŸŽ¯ ===== BACKGROUND: RESEARCH COMPETITOR REQUEST ===== ðŸŽ¯ðŸŽ¯ðŸŽ¯"),console.log("ðŸ“ Seller Username:",r),console.log("ðŸ“ Time:",new Date().toLocaleTimeString());try{const a=`https://www.ebay.com/sch/i.html?_ssn=${encodeURIComponent(r)}&LH_Complete=1&LH_Sold=1&_sop=13&rt=nc&_ipg=200`;console.log("ðŸ”— Opening URL:",a);const i=await chrome.tabs.create({url:a,active:!0});console.log("âœ… Tab created! Tab ID:",i.id),m(i.id,{researchUsername:r,researchUrl:a,researchStartTime:Date.now(),status:"scraping"}),chrome.tabs.onUpdated.addListener(function n(c,l){c===i.id&&l.status==="complete"&&(chrome.tabs.onUpdated.removeListener(n),console.log("âœ… Page loaded! Status: complete"),console.log("â° Waiting 2 seconds for page to fully render..."),setTimeout(()=>{console.log("ðŸ“¨ Sending startCompetitorScraping message to tab:",i.id),chrome.tabs.sendMessage(i.id,{type:"startCompetitorScraping",username:r},u=>{chrome.runtime.lastError?console.error("âŒ Error sending message:",chrome.runtime.lastError):console.log("âœ… Scraping message sent! Response:",u)})},2e3))}),t({success:!0,didResearch:!0,tabId:i.id,message:`Started researching ${r}`})}catch(a){console.error("âŒ Error in competitor research:",a),t({success:!1,didResearch:!1,error:String(a)})}}async function S(e,o,t){var i;const{imageUrl:r,productData:a}=e;console.log("ï¿½ Finding on eBay with product data:",a);try{let n="";if(a.brand&&a.title){const u=a.title.replace(/\([^)]*\)/g,"").replace(/[,]/g," ").replace(/\s+/g," ").split(" ").filter(d=>d.length>0).slice(0,12).join(" ").trim();n=`${a.brand} ${u}`}else if(a.title)n=a.title.replace(/\([^)]*\)/g,"").replace(/[,]/g," ").replace(/\s+/g," ").split(" ").filter(u=>u.length>0).slice(0,15).join(" ").trim();else throw new Error("No product data available");console.log("ðŸ” Search query:",n);const c=`https://www.ebay.com/sch/i.html?_from=R40&_nkw=${encodeURIComponent(n)}&_sacat=0&LH_Sold=1&LH_Complete=1&rt=nc`;console.log("ðŸŒ Opening eBay search URL:",c);const l=await chrome.tabs.create({url:c,active:!0});console.log("âœ… Opened eBay search in tab:",l.id),await chrome.storage.local.set({lastEbaySearch:{query:n,imageUrl:r,productData:a,tabId:l.id,timestamp:Date.now()}}),m(l.id,{searchType:"text",searchQuery:n,imageUrl:r,productData:a,timestamp:Date.now()}),t({success:!0,tabId:l.id,searchQuery:n})}catch(n){console.error("âŒ Error in eBay search:",n);const c=((i=a==null?void 0:a.title)==null?void 0:i.slice(0,100))||"product",l=`https://www.ebay.com/sch/i.html?_nkw=${encodeURIComponent(c)}&LH_Sold=1&LH_Complete=1`;console.log("âš ï¸ Using fallback search:",c);const u=await chrome.tabs.create({url:l,active:!0});t({success:!0,fallback:!0,tabId:u.id})}}function T(e,o,t){const{items:r,sellerName:a}=e;console.log(`âœ… Sold items scanned: ${r.length} items from ${a}`),b({type:"soldItemsUpdate",items:r,sellerName:a,timestamp:Date.now()})}async function g(e,o){console.log("ðŸ¤– Executing automation command:",e.type,e.target);try{if(!e.tabId)throw new Error("Tab ID required for automation command");const t=await chrome.tabs.sendMessage(e.tabId,{type:"automationCommand",command:e});console.log("âœ… Command executed:",t),o({success:!0,result:t})}catch(t){console.error("âŒ Command execution failed:",t),e.retries&&e.retries>0?(console.log(`ðŸ”„ Retrying command (${e.retries} attempts left)...`),e.retries--,setTimeout(()=>{g(e,o)},1e3)):o({success:!1,error:String(t)})}}async function L(e,o){console.log(`ðŸ“‹ Queueing ${e.length} commands`),s.queue.push(...e),s.running||k(),o({success:!0,queueLength:s.queue.length})}async function k(){if(!(s.running||s.queue.length===0)){for(s.running=!0,console.log("ðŸš€ Processing command queue...");s.queue.length>0;){const e=s.queue.shift();if(!e)break;s.currentTask=`${e.type}:${e.target}`;try{await new Promise((o,t)=>{g(e,r=>{r.success?o(r.result):t(r.error)})}),await A(s.settings.delays.betweenActions)}catch(o){console.error("âŒ Command failed in queue:",o)}}s.running=!1,s.currentTask=null,console.log("âœ… Command queue processing complete")}}function m(e,o){const t=s.tabStates.get(e);s.tabStates.set(e,{tabId:e,url:o.url||(t==null?void 0:t.url)||"",status:o.status||"complete",data:{...(t==null?void 0:t.data)||{},...o},lastAction:o.action||(t==null?void 0:t.lastAction)||"init",timestamp:Date.now()}),console.log("ðŸ“Š Tab state updated:",e,o.action||"data")}chrome.tabs.onRemoved.addListener(e=>{s.tabStates.has(e)&&(console.log("ðŸ—‘ï¸ Tab closed, cleaning up state:",e),s.tabStates.delete(e))});async function b(e){try{const o=await chrome.tabs.query({});for(const t of o)if(t.id)try{await chrome.tabs.sendMessage(t.id,e)}catch{}}catch(o){console.error("Error broadcasting to tabs:",o)}}function C(e,o,t){chrome.notifications.create({type:"basic",iconUrl:t||chrome.runtime.getURL("icons/icon128.png"),title:e,message:o,priority:2})}function E(e){const{amazonPrice:o=0,ebayPrice:t=0,shippingCost:r=0,ebayFees:a=.13,paypalFees:i=.029}=e,n=t,c=o+r,l=n*a+n*i+.3,u=n-c-l,d=n>0?u/n*100:0;return{revenue:n,cost:c,fees:l,profit:u,margin:d.toFixed(2),profitable:u>0}}const p=["Hamilton Beach","Ninja","Remington","Apple","Pampers","Tide","Gillette","Nike","Adidas","PlayStation","Sony","Microsoft","Disney","Marvel","Coach","Louis Vuitton","Gucci","Prada"];function U(e){if(!e)return!1;const o=e.toLowerCase();return p.some(t=>o.includes(t.toLowerCase()))}const h=["replica","fake","knock-off","counterfeit","bootleg","unauthorized","import","parallel import"];function I(e){if(!e)return[];const o=e.toLowerCase();return h.filter(t=>o.includes(t.toLowerCase()))}function A(e){return new Promise(o=>setTimeout(o,e))}chrome.runtime.onInstalled.addListener(e=>{console.log("ðŸŽ‰ EcomFlow extension installed/updated:",e.reason),chrome.storage.local.set({settings:s.settings,veroList:p,restrictedWords:h})});export{E as calculateProfit,I as checkRestrictedWords,U as checkVEROList,g as executeAutomationCommand,L as queueCommands};
